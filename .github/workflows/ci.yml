name: ğŸš€ Continuous Integration

on:
  push:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  pull_request:
    branches: [ main, develop ]
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.gitignore'
  workflow_dispatch:

env:
  GO_VERSION: '1.23'
  GOPROXY: https://proxy.golang.org,direct
  GOSUMDB: sum.golang.org

jobs:
  # ğŸ§ª Testing Job
  test:
    name: ğŸ§ª Test Suite
    runs-on: ubuntu-latest
    strategy:
      matrix:
        go-version: ['1.22', '1.23']
        os: [ubuntu-latest, macos-latest, windows-latest]
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ¹ Setup Go ${{ matrix.go-version }}
      uses: actions/setup-go@v4
      with:
        go-version: ${{ matrix.go-version }}
        cache: true
    
    - name: ğŸ“¦ Download Dependencies
      run: |
        go mod download
        go mod verify
    
    - name: ğŸ” Run Go Vet
      run: go vet ./...
    
    - name: ğŸ§¹ Run Go Fmt Check
      run: |
        if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
          echo "âŒ Code is not formatted properly:"
          gofmt -s -l .
          exit 1
        fi
        echo "âœ… Code is properly formatted"
      shell: bash
    
    - name: ğŸ§ª Run Tests
      run: |
        echo "ğŸ§ª Running tests with coverage..."
        go test -v -race -coverprofile=coverage.out -covermode=atomic ./...
    
    - name: ğŸ“Š Upload Coverage
      if: matrix.os == 'ubuntu-latest' && matrix.go-version == '1.23'
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.out
        flags: unittests
        name: codecov-umbrella
    
    - name: ğŸ—ï¸ Build Binary
      run: |
        echo "ğŸ—ï¸ Building gocat binary..."
        go build -v -o gocat .
    
    - name: âœ… Test Binary
      run: |
        echo "âœ… Testing binary functionality..."
        ./gocat --help
        ./gocat --version || ./gocat -v || echo "Version flag not implemented yet"
      shell: bash

  # ğŸ”’ Security Scan
  security:
    name: ğŸ”’ Security Scan
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ¹ Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
    
    - name: ğŸ” Run Gosec Security Scanner
      continue-on-error: true
      uses: securecodewarrior/github-action-gosec@master
      with:
        args: '-fmt sarif -out gosec.sarif ./...'
    
    - name: ğŸ“¤ Upload SARIF file
      continue-on-error: true
      uses: github/codeql-action/upload-sarif@v2
      with:
        sarif_file: gosec.sarif

  # ğŸ“ Code Quality
  quality:
    name: ğŸ“ Code Quality
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: ğŸ¹ Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
    
    - name: ğŸ”§ Install golangci-lint
      continue-on-error: true
      uses: golangci/golangci-lint-action@v4
      with:
        version: latest
        args: --timeout=5m
    
    - name: ğŸ“Š SonarCloud Scan
      if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.full_name == github.repository
      continue-on-error: true
      uses: SonarSource/sonarcloud-github-action@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}

  # ğŸ—ï¸ Build Matrix
  build:
    name: ğŸ—ï¸ Build (${{ matrix.goos }}/${{ matrix.goarch }})
    runs-on: ubuntu-latest
    needs: [test, security, quality]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    strategy:
      matrix:
        include:
          - goos: linux
            goarch: amd64
            artifact: gocat-linux-amd64
          - goos: linux
            goarch: arm64
            artifact: gocat-linux-arm64
          - goos: darwin
            goarch: amd64
            artifact: gocat-darwin-amd64
          - goos: darwin
            goarch: arm64
            artifact: gocat-darwin-arm64
          - goos: windows
            goarch: amd64
            artifact: gocat-windows-amd64.exe
          - goos: freebsd
            goarch: amd64
            artifact: gocat-freebsd-amd64
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ¹ Setup Go
      uses: actions/setup-go@v4
      with:
        go-version: ${{ env.GO_VERSION }}
        cache: true
    
    - name: ğŸ—ï¸ Build Binary
      env:
        GOOS: ${{ matrix.goos }}
        GOARCH: ${{ matrix.goarch }}
        CGO_ENABLED: 0
      run: |
        echo "ğŸ—ï¸ Building for ${{ matrix.goos }}/${{ matrix.goarch }}..."
        
        # Build flags
        BUILD_TIME=$(date -u +%Y-%m-%dT%H:%M:%SZ)
        GIT_COMMIT=$(git rev-parse --short HEAD)
        VERSION=${GITHUB_REF#refs/tags/}
        
        LDFLAGS="
          -s -w
          -X main.version=${VERSION}
          -X main.buildTime=${BUILD_TIME}
          -X main.gitCommit=${GIT_COMMIT}
        "
        
        go build \
          -trimpath \
          -ldflags="${LDFLAGS}" \
          -o ${{ matrix.artifact }} \
          .
        
        echo "âœ… Build completed: ${{ matrix.artifact }}"
        ls -la ${{ matrix.artifact }}
    
    - name: ğŸ“¤ Upload Artifacts
      uses: actions/upload-artifact@v3
      with:
        name: ${{ matrix.artifact }}
        path: ${{ matrix.artifact }}
        retention-days: 30

  # ğŸ“¦ Package Creation
  package:
    name: ğŸ“¦ Create Packages
    runs-on: ubuntu-latest
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    steps:
    - name: ğŸ“¥ Checkout Code
      uses: actions/checkout@v4
    
    - name: ğŸ“¥ Download Linux AMD64 Artifact
      uses: actions/download-artifact@v3
      with:
        name: gocat-linux-amd64
        path: ./
    
    - name: ğŸ”§ Setup Package Tools
      run: |
        sudo apt-get update
        sudo apt-get install -y dpkg-dev rpm
    
    - name: ğŸ“¦ Create Debian Package
      run: |
        echo "ğŸ“¦ Creating Debian package..."
        chmod +x gocat-linux-amd64
        mv gocat-linux-amd64 gocat
        chmod +x pkg/Debian/build-deb.sh
        cd pkg/Debian
        ./build-deb.sh 1.0.0 amd64
    
    - name: ğŸ“¤ Upload Debian Package
      uses: actions/upload-artifact@v3
      with:
        name: debian-package
        path: pkg/Debian/*.deb
        retention-days: 30

  # ğŸ¯ Deployment Status
  status:
    name: ğŸ¯ CI Status
    runs-on: ubuntu-latest
    needs: [test, security, quality, build, package]
    if: always()
    
    steps:
    - name: ğŸ“Š Report Status
      run: |
        echo "ğŸ¯ CI Pipeline Status Report"
        echo "========================="
        echo "âœ… Tests: ${{ needs.test.result }}"
        echo "ğŸ”’ Security: ${{ needs.security.result }}"
        echo "ğŸ“ Quality: ${{ needs.quality.result }}"
        echo "ğŸ—ï¸ Build: ${{ needs.build.result }}"
        echo "ğŸ“¦ Package: ${{ needs.package.result }}"
        
        if [[ "${{ needs.test.result }}" == "success" && 
              "${{ needs.security.result }}" == "success" && 
              "${{ needs.quality.result }}" == "success" ]]; then
          echo "ğŸ‰ All checks passed!"
          exit 0
        else
          echo "âŒ Some checks failed!"
          exit 1
        fi